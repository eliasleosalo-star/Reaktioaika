<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reaktioaikatesti</title>
  <meta name="description" content="Yksinkertainen reaktioaikatesti: odota vihre√§√§ ja klikkaa niin nopeasti kuin pystyt." />
  <style>
    :root {
      --bg-idle: #0f172a;    /* slate-900 */
      --bg-wait: #ef4444;    /* red-500 */
      --bg-go:   #22c55e;    /* green-500 */
      --bg-early:#f59e0b;    /* amber-500 */
      --text:    #e5e7eb;    /* gray-200 */
      --muted:   #94a3b8;    /* slate-400 */
      --card:    rgba(15, 23, 42, 0.6);
      --btn:     #1f2937;    /* gray-800 */
      --btnh:    #374151;    /* gray-700 */
      --accent:  #38bdf8;    /* sky-400 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      display: grid;
      place-items: center;
      background: var(--bg-idle);
      transition: background-color 140ms ease-in-out, background 140ms ease-in-out;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      outline: none;
    }
    body.wait    { background: var(--bg-wait); }
    body.go      { background: var(--bg-go); }
    body.early   { background: var(--bg-early); }

    #app {
      width: min(920px, 92vw);
      display: grid;
      gap: 18px;
      text-align: center;
      padding: 24px;
    }
    .title { font-size: clamp(28px, 5vw, 44px); font-weight: 800; letter-spacing: 0.3px; }
    .message { font-size: clamp(22px, 4vw, 34px); font-weight: 700; }
    .subtext { font-size: clamp(14px, 2.4vw, 18px); color: var(--muted); }

    .row { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
    .chip { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); padding: 10px 14px; border-radius: 999px; font-weight: 600; }

    .panel {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(6px);
      padding: 16px 18px;
      border-radius: 16px;
    }

    .grid {
      display: grid; gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    button, .btn-like {
      appearance: none; border: none; cursor: pointer; color: var(--text); font-weight: 700;
      background: var(--btn); padding: 10px 14px; border-radius: 12px; transition: transform 80ms ease, background 120ms;
    }
    button:hover { background: var(--btnh); }
    button:active { transform: translateY(1px) scale(0.99); }
    .btn-accent { background: var(--accent); color: #031525; }
    .btn-ghost { background: transparent; border: 1px dashed rgba(255,255,255,0.24); }

    .stat {
      font-size: clamp(22px, 4vw, 30px); font-weight: 800;
    }
    .small { font-size: 12px; letter-spacing: 0.4px; text-transform: uppercase; color: var(--muted); }

    footer { opacity: 0.9; font-size: 12px; color: var(--muted); text-align: center; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight: 700; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.18); }

    /* Big click area overlay for instructions */
    #overlay { position: fixed; inset: 0; }
  </style>
</head>
<body tabindex="0" aria-live="polite">
  <div id="overlay" aria-hidden="true"></div>

  <main id="app" role="main">
    <div class="title">Reaktioaikatesti</div>
    <div id="message" class="message">Klikkaa tai paina <span class="kbd">v√§lily√∂nti</span> aloittaaksesi</div>
    <div id="sub" class="subtext">Kun tausta vaihtuu <strong>vihre√§ksi</strong>, klikkaa niin nopeasti kuin pystyt.</div>

    <div class="grid">
      <section class="panel" aria-label="Tulos & tilastot">
        <div class="row" style="justify-content: space-between; gap: 16px;">
          <div>
            <div class="small">Viimeisin</div>
            <div id="last" class="stat">‚Äì</div>
          </div>
          <div>
            <div class="small">Paras</div>
            <div id="best" class="stat">‚Äì</div>
          </div>
          <div>
            <div class="small">Keskiarvo (5)</div>
            <div id="avg" class="stat">‚Äì</div>
          </div>
        </div>
      </section>

      <section class="panel" aria-label="Asetukset & toiminnot">
        <div class="row">
          <button id="toggle-sound" type="button" aria-pressed="true">üîä √Ñ√§ni p√§√§ll√§</button>
          <button id="share" type="button">üì§ Jaa tulos</button>
          <button id="reset" type="button" class="btn-ghost">‚ôªÔ∏è Nollaa tilastot</button>
        </div>
        <div class="subtext" style="margin-top:8px">Vinkki: voit k√§ytt√§√§ my√∂s <span class="kbd">Enter</span>- tai <span class="kbd">v√§lily√∂nti</span>-n√§pp√§int√§.</div>
      </section>

      <section class="panel" aria-label="Historia">
        <div class="small">Viimeiset tulokset</div>
        <div id="history" class="subtext">‚Äî</div>
      </section>
    </div>

    <footer>
      Rakennettu ilman kirjastoja. ¬© <span id="year"></span> ‚Ä¢ <a href="#" id="permalink">Pysyv√§ linkki t√§lle ty√∂kalulle</a>
    </footer>
  </main>

  <script>
    (function() {
      const $ = (id) => document.getElementById(id);
      const body = document.body;
      const msg = $("message");
      const sub = $("sub");
      const lastEl = $("last");
      const bestEl = $("best");
      const avgEl  = $("avg");
      const histEl = $("history");
      const btnSound = $("toggle-sound");
      const btnShare = $("share");
      const btnReset = $("reset");
      const overlay = $("overlay");
      const YEAR = $("year"); YEAR.textContent = new Date().getFullYear();
      const link = $("permalink"); link.addEventListener('click', e => { e.preventDefault(); navigator.clipboard.writeText(location.href).then(() => toast('Linkki kopioitu')); });

      let state = 'idle';
      let timer = null;
      let startTs = 0;
      let results = JSON.parse(localStorage.getItem('rt_results') || '[]');
      let best = Number(localStorage.getItem('rt_best') || '0');
      let beepOn = JSON.parse(localStorage.getItem('rt_beep') || 'true');

      // WebAudio beep when GO
      let ctx = null;
      function beep() {
        if (!beepOn) return;
        try {
          ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(880, ctx.currentTime);
          g.gain.setValueAtTime(0.001, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.16);
          o.connect(g).connect(ctx.destination);
          o.start();
          o.stop(ctx.currentTime + 0.18);
        } catch {}
      }

      function fmt(ms) { return Math.round(ms) + ' ms'; }
      function averageLast(n=5) { const arr = results.slice(-n); if (!arr.length) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }
      function updateStatsDisplay(lastVal = null) {
        lastEl.textContent = lastVal ? fmt(lastVal) : (results.length ? fmt(results[results.length-1]) : '‚Äì');
        bestEl.textContent = best ? fmt(best) : '‚Äì';
        const avg = averageLast();
        avgEl.textContent = avg ? fmt(avg) : '‚Äì';
        histEl.textContent = results.length ? results.slice(-10).map(v=>fmt(v)).join(' ¬∑ ') : '‚Äî';
      }

      function saveStats() {
        localStorage.setItem('rt_results', JSON.stringify(results));
        localStorage.setItem('rt_best', String(best));
      }

      function setState(next) {
        state = next;
        body.classList.remove('wait','go','early');
        switch(next) {
          case 'idle':
            msg.innerHTML = 'Klikkaa tai paina <span class="kbd">v√§lily√∂nti</span> aloittaaksesi';
            sub.innerHTML = 'Kun tausta vaihtuu <strong>vihre√§ksi</strong>, klikkaa niin nopeasti kuin pystyt.';
            break;
          case 'wait':
            body.classList.add('wait');
            msg.textContent = 'Odota vihre√§√§‚Ä¶';
            sub.textContent = '√Ñl√§ klikkaa viel√§!';
            break;
          case 'go':
            body.classList.add('go');
            msg.textContent = 'Nyt! Klikkaa!';
            sub.textContent = 'Mittaa reaktioaikasi';
            break;
          case 'early':
            body.classList.add('early');
            msg.textContent = 'Liian aikaisin!';
            sub.textContent = 'Klikkaa yritt√§√§ksesi uudelleen';
            break;
          case 'result':
            msg.textContent = 'Hyv√§! Klikkaa yritt√§√§ksesi uudelleen';
            sub.textContent = 'Kokeile parantaa tulostasi';
            break;
        }
      }

      function startRound() {
        if (timer) clearTimeout(timer);
        setState('wait');
        const delay = Math.floor(1000 + Math.random()*3000); // 1000‚Äì4000 ms
        timer = setTimeout(() => {
          startTs = performance.now();
          setState('go');
          beep();
        }, delay);
      }

      function tooSoon() {
        if (timer) clearTimeout(timer);
        setState('early');
      }

      function finishRound() {
        const rt = performance.now() - startTs;
        results.push(rt);
        if (!best || rt < best) best = rt;
        saveStats();
        updateStatsDisplay(rt);
        setState('result');
      }

      function handlePress() {
        switch(state) {
          case 'idle':
          case 'result':
          case 'early':
            startRound();
            break;
          case 'wait':
            tooSoon();
            break;
          case 'go':
            finishRound();
            break;
        }
      }

      // Input handlers
      overlay.addEventListener('pointerdown', (e) => { e.preventDefault(); handlePress(); }, { passive: false });
      document.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        if (e.code === 'Space' || e.code === 'Enter' || e.code === 'NumpadEnter') {
          e.preventDefault();
          handlePress();
        }
      });

      // Buttons
      function renderSoundBtn() {
        btnSound.textContent = (beepOn ? 'üîä √Ñ√§ni p√§√§ll√§' : 'üîá √Ñ√§ni pois');
        btnSound.setAttribute('aria-pressed', String(beepOn));
      }
      btnSound.addEventListener('click', () => { beepOn = !beepOn; localStorage.setItem('rt_beep', JSON.stringify(beepOn)); renderSoundBtn(); });

      btnShare.addEventListener('click', async () => {
        const last = results.at(-1);
        const text = last ? `Reaktioaikani: ${fmt(last)} ‚Äî testaa oma t√§√§ll√§!` : 'Testaa reaktioaikasi!';
        try {
          if (navigator.share) {
            await navigator.share({ title: 'Reaktioaikatesti', text, url: location.href });
          } else {
            await navigator.clipboard.writeText(`${text} ${location.href}`);
            toast('Kopioitu leikep√∂yd√§lle');
          }
        } catch {}
      });

      btnReset.addEventListener('click', () => {
        results = [];
        best = 0;
        saveStats();
        updateStatsDisplay();
        toast('Tilastot nollattu');
      });

      // Tiny toast
      let toastEl = null; let toastTimer = null;
      function toast(text) {
        if (!toastEl) {
          toastEl = document.createElement('div');
          toastEl.style.cssText = 'position:fixed;left:50%;bottom:26px;transform:translateX(-50%);background:rgba(15,23,42,.9);color:#e5e7eb;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.15);font-weight:700;z-index:9999;';
          document.body.appendChild(toastEl);
        }
        toastEl.textContent = text;
        toastEl.style.opacity = '1';
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => { toastEl.style.opacity = '0'; }, 1200);
      }

      // Init
      renderSoundBtn();
      updateStatsDisplay();
      setState('idle');
      // Focus for keyboard use
      setTimeout(() => { try { document.body.focus(); } catch {} }, 0);
    })();
  </script>
</body>
</html>
