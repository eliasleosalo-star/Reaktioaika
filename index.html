<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reaktioaika.fi – Valitse peli</title>
  <meta name="description" content="Testaa reaktioaikasi kahdella pelillä: vihreä tausta ja aikaarvio 30 s. 5 yrityksen sarjat, keskiarvo ja paras tulos." />
  <style>
    :root{
      --bg: #0f172a;      /* tausta */
      --bg-wait:#ef4444;  /* punainen */
      --bg-go:#22c55e;    /* vihreä */
      --text:#e5e7eb;
      --sub:#94a3b8;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--text); display:flex; flex-direction:column; min-height:100vh;
      transition:background 140ms ease-in-out;
      user-select:none; -webkit-tap-highlight-color:transparent; touch-action:manipulation;
    }
    header{padding:16px; background:#1e293b; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:center; text-align:center}
    header h1{margin:0; font-size:20px; font-weight:800}
    header .select-wrap{display:flex; gap:8px; align-items:center}
    select{padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:var(--text)}
    main{flex:1; display:flex; flex-direction:column; align-items:center; gap:16px; padding:18px; text-align:center}
    .title{font-size:clamp(22px,3.8vw,32px); font-weight:800}
    .sub {color:var(--sub)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-weight:700; background:rgba(255,255,255,.08); padding:2px 6px; border-radius:6px; border:1px solid var(--border)}
    .spacer{height:clamp(160px,34vh,440px); width:100%}
    .panel{width:min(960px,95vw); background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px}
    .row{display:flex; flex-wrap:wrap; gap:14px; align-items:center; justify-content:space-between}
    .stat{font-size:clamp(22px,4vw,28px); font-weight:800}
    .small{font-size:12px; color:var(--sub); text-transform:uppercase; letter-spacing:.3px}
    button{appearance:none; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; color:var(--text); background:#1f2937}
    button:hover{background:#374151}
    footer{padding:14px; color:var(--sub); text-align:center; font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Reaktioaika.fi – Pelit</h1>
    <div class="select-wrap">
      <label for="game-select">Valitse peli:</label>
      <select id="game-select">
        <option value="reaction">Reaktiotesti (vihreä tausta)</option>
        <option value="time-guess">Aikaarvio 30 s</option>
      </select>
    </div>
  </header>

  <main>
    <div class="title" id="message">Valitse peli ja aloita!</div>
    <div class="sub" id="sub">Klikkaa tai paina <span class="kbd">välilyönti</span> aloittaaksesi.</div>

    <!-- Iso klikkausalue – peli saa tilaa -->
    <div class="spacer" aria-hidden="true"></div>

    <!-- Tulokset -->
    <section class="panel" aria-label="Tulos & tilastot">
      <div class="row">
        <div><div class="small">Viimeisin</div><div id="last" class="stat">–</div></div>
        <div><div class="small">Paras</div><div id="best" class="stat">–</div></div>
        <div><div class="small">Keskiarvo (5)</div><div id="avg" class="stat">–</div></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="reset">♻️ Nollaa</button>
      </div>
      <div class="small" style="margin-top:10px;">Viimeiset tulokset</div>
      <div id="history" class="sub">—</div>
    </section>
  </main>

  <footer>© <span id="year"></span> Reaktioaika.fi</footer>

  <script>
    // --- Perusviitteet
    const YEAR = document.getElementById('year'); YEAR.textContent = new Date().getFullYear();
    const sel = document.getElementById('game-select');
    const msg = document.getElementById('message');
    const sub = document.getElementById('sub');
    const lastEl = document.getElementById('last');
    const bestEl = document.getElementById('best');
    const avgEl  = document.getElementById('avg');
    const histEl = document.getElementById('history');
    const btnReset = document.getElementById('reset');

    // --- Peli-tila
    const TRIALS = 5;
    let game = 'reaction';
    let state = 'idle'; // 'idle' | 'wait' | 'go' | 'timing' | 'done' | 'early'
    let results = [];   // kuluvan sarjan 1..5
    let best = 0;       // pienin reaktio / pienin virhe (pelikohtainen)
    let startTs = 0;
    let timer = null;

    // --- Formatterit
    const fmtMs = (ms) => Math.round(ms) + ' ms';
    const fmtSec = (ms) => (ms/1000).toFixed(2).replace('.', ',') + ' s'; // 2,35 s
    const avg = (arr) => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;

    const saveBest = () => localStorage.setItem('best_'+game, String(best));
    const loadBest = () => Number(localStorage.getItem('best_'+game) || '0');
    const setBg = (c) => document.body.style.background = c || 'var(--bg)';

    function updateStats(lastVal=null){
      if (game === 'time-guess') {
        const show = (v) => fmtSec(v);
        lastEl.textContent = lastVal!=null ? show(lastVal) : (results.length ? show(results.at(-1)) : '–');
        bestEl.textContent = best ? show(best) : '–';
        const a = avg(results);
        avgEl.textContent = results.length ? show(a) : '–';
        histEl.textContent = results.length ? results.map(show).join(' · ') : '—';
      } else {
        lastEl.textContent = lastVal!=null ? fmtMs(lastVal) : (results.length?fmtMs(results.at(-1)):'–');
        bestEl.textContent = best ? fmtMs(best) : '–';
        const a = avg(results);
        avgEl.textContent = results.length ? fmtMs(a) : '–';
        histEl.textContent = results.length ? results.map(v=>fmtMs(v)).join(' · ') : '—';
      }
    }

    function resetSeries(keepBest=true){
      results = [];
      if(!keepBest){ best = 0; saveBest(); }
      updateStats();
      state = 'idle';
      setBg('var(--bg)');
      if(game==='reaction'){
        msg.textContent = 'Klikkaa aloittaaksesi – odota vihreää';
        sub.innerHTML = 'Sarja: 5 yritystä. Älä klikkaa ennen vihreää.';
      } else if(game==='time-guess'){
        msg.textContent = 'Klikkaa aloittaaksesi aikaarvion (30 s)';
        sub.innerHTML = 'Paina uudelleen, kun <strong>arvioit 30 sekunnin</strong> kuluneen.';
      }
    }

    // --- Pelinvaihto
    function setGame(id){
      clearTimeout(timer); timer = null;
      game = id;
      best = loadBest();
      resetSeries(true);
    }
    sel.addEventListener('change', () => setGame(sel.value));

    // --- Pelit
    function startRound(){
      if(game==='reaction'){
        // Punainen odotus -> viive -> vihreä
        state='wait';
        msg.textContent='Odota vihreää…';
        sub.textContent='Älä klikkaa vielä!';
        setBg('var(--bg-wait)');
        timer = setTimeout(()=>{
          state='go';
          startTs = performance.now();
          setBg('var(--bg-go)');
          msg.textContent='Nyt! Klikkaa!';
          sub.textContent='Mittaa reaktioaikasi';
        }, 2500 + Math.random()*3500); // 2500–6000 ms
      }
      else if(game==='time-guess'){
        // Käynnistä aikamittaus ilman näkyvää kelloa
        state='timing';
        startTs = performance.now();
        msg.textContent='Käynnissä… Klikkaa, kun 30 s on mielestäsi kulunut.';
        sub.textContent='Vinkki: älä laske ääneen – luota tuntumaan.';
        setBg('#0f172a');
      }
    }

    function tooSoon(){
      clearTimeout(timer);
      state='early';
      msg.textContent='Liian aikaisin!';
      sub.textContent='Klikkaa aloittaaksesi uuden kierroksen.';
      setBg('var(--bg)');
    }

    function finishReaction(){
      const rt = performance.now() - startTs;
      results.push(rt);
      if(!best || rt < best) { best = rt; saveBest(); }
      updateStats(rt);
      setBg('var(--bg)');
      if(results.length>=TRIALS){
        state='done';
        msg.textContent = 'Sarja valmis! Keskiarvo: ' + fmtMs(avg(results));
        sub.textContent = 'Klikkaa aloittaaksesi uuden 5 yrityksen sarjan.';
      } else {
        state='idle';
        msg.textContent='Hyvä! Klikkaa jatkaaksesi';
        sub.textContent='Yrittelyttääkö parempi tulos?';
      }
    }

    function finishTimeGuess(){
      const elapsed = performance.now() - startTs; // ms
      const target = 30000; // 30 s
      const error = Math.abs(elapsed - target);
      results.push(error);
      if(!best || error < best){ best = error; saveBest(); }
      updateStats(error);
      msg.textContent = `Arvioit: ${fmtSec(elapsed)} → virhe ${fmtSec(error)}`;
      if(results.length>=TRIALS){
        state='done';
        sub.textContent = 'Sarja valmis! Keskivirhe: ' + fmtSec(avg(results));
      } else {
        state='idle';
        sub.textContent = 'Klikkaa aloittaaksesi seuraavan arvion.';
      }
    }

    // --- Syötteet
    document.body.addEventListener('pointerdown', () => {
      if(game==='reaction'){
        if(state==='idle' || state==='done' || state==='early'){ startRound(); }
        else if(state==='wait'){ tooSoon(); }
        else if(state==='go'){ finishReaction(); }
      }
      else if(game==='time-guess'){
        if(state==='idle' || state==='done'){ startRound(); }
        else if(state==='timing'){ finishTimeGuess(); }
      }
    });

    document.addEventListener('keydown', (e) => {
      if(e.repeat) return;
      if(e.code==='Space' || e.code==='Enter' || e.code==='NumpadEnter'){
        e.preventDefault();
        if(game==='reaction'){
          if(state==='idle' || state==='done' || state==='early'){ startRound(); }
          else if(state==='wait'){ tooSoon(); }
          else if(state==='go'){ finishReaction(); }
        }
        else if(game==='time-guess'){
          if(state==='idle' || state==='done'){ startRound(); }
          else if(state==='timing'){ finishTimeGuess(); }
        }
      }
    });

    btnReset.addEventListener('click', () => {
      results = [];
      best = 0;
      saveBest();
      updateStats();
      msg.textContent = 'Nollattu. Klikkaa aloittaaksesi.';
      sub.textContent = 'Sarja: 5 yritystä.';
      state = 'idle';
      setBg('var(--bg)');
    });

    // --- Init
    (function init(){
      // peli URL-paramista (esim. ?game=time-guess)
      const p = new URLSearchParams(location.search).get('game');
      if(p && ['reaction','time-guess'].includes(p)){
        sel.value = p;
      }
      setGame(sel.value);
    })();
  </script>
</body>
</html>
