<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reaktioaikatestit – Valitse peli</title>
  <meta name="description" content="Testaa reaktioaikasi erilaisilla nopeus- ja aikapeleillä: vihreä tausta, täppää kohde ja aikaarvio 30s." />
  <style>
    body {
      margin:0;
      font-family: system-ui, sans-serif;
      background:#0f172a;
      color:#e5e7eb;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    header {
      padding:1rem;
      background:#1e293b;
      text-align:center;
    }
    main {
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:1rem;
      padding:1rem;
      text-align:center;
    }
    select {
      padding:.5rem 1rem;
      border-radius:.5rem;
      border:none;
      font-size:1rem;
    }
    #game-area {
      flex:1;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .panel {
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:.75rem;
      padding:1rem;
      margin-top:1rem;
      max-width:600px;
      width:100%;
      z-index:5;
    }
    .stat {font-size:1.4rem;font-weight:700;}
    .small {font-size:.8rem;color:#94a3b8;text-transform:uppercase;}
    footer {padding:1rem;font-size:.8rem;color:#94a3b8;text-align:center;}
    /* Tap target style */
    .target {
      position:fixed;
      width:60px;height:60px;
      border-radius:9999px;
      background:#22c55e;
      box-shadow:0 0 0 6px rgba(34,197,94,.3);
      cursor:pointer;
      z-index:10;
    }
  </style>
</head>
<body>
  <header>
    <h1>Reaktioaikatestit</h1>
    <label for="game-select">Valitse peli:</label>
    <select id="game-select">
      <option value="reaction">Reaktiotesti (vihreä tausta)</option>
      <option value="tap-target">Täppää kohde</option>
      <option value="time-est">Aikaarvio 30s</option>
    </select>
  </header>
  <main>
    <div id="instructions">Valitse peli ja aloita!</div>
    <div id="game-area" tabindex="0"></div>
    <section class="panel" id="stats">
      <div class="row">
        <div><div class="small">Viimeisin</div><div id="last" class="stat">–</div></div>
        <div><div class="small">Paras</div><div id="best" class="stat">–</div></div>
        <div><div class="small">Keskiarvo (5)</div><div id="avg" class="stat">–</div></div>
      </div>
      <div class="small" style="margin-top:.5rem">Viimeiset tulokset</div>
      <div id="history">—</div>
      <button id="reset" style="margin-top:.5rem">♻️ Nollaa</button>
    </section>
  </main>
  <footer>© <span id="year"></span> Reaktioaika.fi</footer>

  <script>
    const YEAR=document.getElementById("year");YEAR.textContent=new Date().getFullYear();
    const sel=document.getElementById("game-select");
    const instr=document.getElementById("instructions");
    const statsBox=document.getElementById("stats");
    const lastEl=document.getElementById("last"),bestEl=document.getElementById("best"),avgEl=document.getElementById("avg"),histEl=document.getElementById("history");
    const resetBtn=document.getElementById("reset");
    let game="reaction"; let state="idle"; let timer=null; let startTs=0;
    let results=[],best=0; const TRIALS=5;
    const TARGET=30000; // 30 s aikaarvio

    function fmtMs(ms){return Math.round(ms)+" ms";}
    function fmtSec(sec){return sec.toFixed(2).replace(".",",")+" s";}
    function avg(arr){return arr.reduce((a,b)=>a+b,0)/arr.length;}

    function updateStats(lastVal=null){
      if(game==="time-est"){
        lastEl.textContent=lastVal!==null?fmtSec(lastVal/1000):(results.length?fmtSec(results.at(-1)/1000):"–");
        bestEl.textContent=best?fmtSec(best/1000):"–";
        avgEl.textContent=(results.length?fmtSec(avg(results)/1000):"–");
        histEl.textContent=results.length?results.map(r=>fmtSec(r/1000)).join(" · "):"—";
      } else {
        lastEl.textContent=lastVal?fmtMs(lastVal):(results.length?fmtMs(results.at(-1)):"–");
        bestEl.textContent=best?fmtMs(best):"–";
        avgEl.textContent=(results.length?fmtMs(avg(results)):"–");
        histEl.textContent=results.length?results.map(fmtMs).join(" · "):"—";
      }
    }
    function saveStats(){localStorage.setItem("best_"+game,best);}
    function loadStats(){best=Number(localStorage.getItem("best_"+game)||0);results=[];updateStats();}

    function startRound(){
      if(game==="reaction"){
        instr.textContent="Odota vihreää...";
        state="wait";
        timer=setTimeout(()=>{
          state="go"; startTs=performance.now();
          document.body.style.background="#22c55e";
          instr.textContent="Nyt! Klikkaa!";
        },2500+Math.random()*3500);
        document.body.style.background="#ef4444";
      } else if(game==="tap-target"){
        instr.textContent="Odota kohdetta...";
        state="wait";
        timer=setTimeout(()=>{
          startTs=performance.now(); state="go";
          spawnTarget();
        },2500+Math.random()*3500);
      } else if(game==="time-est"){
        instr.textContent="Aloita klikkaamalla. Pysäytä kun luulet 30 s kuluneen.";
        state="running";
        startTs=performance.now();
      }
    }

    function handlePress(){
      if(game==="reaction"){
        if(state==="wait"){tooSoon();}
        else if(state==="go"){finish();}
        else if(state==="idle"||state==="done"){newSeries();}
      } else if(game==="time-est"){
        if(state==="idle"||state==="done"){newSeries();}
        else if(state==="running"){finishTimeEst();}
      }
    }
    function tooSoon(){clearTimeout(timer);instr.textContent="Liian aikaisin!";state="done";}
    function finish(){
      const rt=performance.now()-startTs;
      results.push(rt); if(!best||rt<best) best=rt;
      saveStats(); updateStats(rt); 
      if(results.length>=TRIALS){instr.textContent="Sarja valmis! Keskiarvo "+fmtMs(avg(results));state="done";}
      else {instr.textContent="Klikkaa jatkaaksesi";state="idle";}
      document.body.style.background="#0f172a";
    }
    function finishTimeEst(){
      const elapsed=performance.now()-startTs;
      const error=Math.abs(elapsed-TARGET);
      results.push(error); if(!best||error<best) best=error;
      saveStats(); updateStats(error);
      instr.textContent="Arvioit: "+fmtSec(elapsed/1000)+" → virhe "+fmtSec(error/1000);
      if(results.length>=TRIALS){instr.textContent+="\nSarja valmis! Keskiarvo "+fmtSec(avg(results)/1000);state="done";}
      else {state="idle";}
    }
    function newSeries(){results=[];updateStats();startRound();}

    function spawnTarget(){
      const t=document.createElement("div");t.className="target";
      const m=80;
      const statsTop=statsBox.getBoundingClientRect().top;
      const maxY=statsTop-80;
      const x=m+Math.random()*(window.innerWidth-2*m-60);
      const y=m+Math.random()*(maxY-m);
      t.style.left=x+"px";t.style.top=y+"px";
      t.onclick=()=>{const rt=performance.now()-startTs;results.push(rt);if(!best||rt<best)best=rt;saveStats();updateStats(rt);
        t.remove();
        if(results.length>=TRIALS){instr.textContent="Sarja valmis! Keskiarvo "+fmtMs(avg(results));state="done";}
        else{instr.textContent="Klikkaa jatkaaksesi";state="idle";}
      };
      document.body.appendChild(t);
    }

    // event listeners
    document.body.addEventListener("pointerdown",()=>{if(game==="reaction"||game==="time-est")handlePress(); else if(game==="tap-target"&&state==="idle"){startRound();}});
    document.addEventListener("keydown",e=>{if(e.code==="Space"||e.code==="Enter"){if(game==="reaction"||game==="time-est")handlePress(); else if(game==="tap-target"&&state==="idle"){startRound();}}});
    resetBtn.onclick=()=>{results=[];best=0;saveStats();updateStats();instr.textContent="Nollattu. Klikkaa aloittaaksesi.";state="idle";};
    sel.onchange=()=>{game=sel.value;loadStats();instr.textContent="Peli vaihdettu. Klikkaa aloittaaksesi.";document.body.style.background="#0f172a";state="idle";};

    loadStats();instr.textContent="Klikkaa aloittaaksesi.";
  </script>
</body>
</html>
