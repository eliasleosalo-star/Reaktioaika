<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sokkosidokset ‚Äì P√§iv√§n challenge</title>
<meta name="description" content="Sokkosidokset: sosiaalinen linkkipeli. Pelaa bottien kanssa p√§iv√§n haaste ‚Äì paljastus lopussa!" />
<style>
  :root{
    --bg:#0f172a; --panel:#121b30; --border:#27324a; --text:#e5e7eb; --muted:#93a4bf;
    --acc:#38bdf8; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#1b2540;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:var(--bg); color:var(--text); display:flex; min-height:100vh; flex-direction:column;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; user-select:none;
  }
  header{background:#13203a;border-bottom:1px solid var(--border);padding:14px}
  .wrap{width:min(1100px,94vw); margin:0 auto}
  h1{margin:0;font-size:20px;font-weight:800}
  .sub{color:var(--muted);font-size:13px}
  .banner{margin-top:6px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{background:#0b162d;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-weight:700}

  main{flex:1;display:flex;align-items:center;justify-content:center;padding:18px}
  .card{width:min(1100px,94vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px}
  .title{font-size:clamp(22px,4vw,28px);font-weight:800}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;gap:10px}
  .grid.players{grid-template-columns: repeat(auto-fit,minmax(160px,1fr));}
  .chip{background:var(--chip);border:1px solid var(--border);padding:10px;border-radius:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .chip[aria-pressed="true"]{outline:2px solid var(--acc)}
  .muted{color:var(--muted)}
  .kbd{font-family:ui-monospace, Menlo, Consolas, monospace; background:#0b162d; border:1px solid var(--border); padding:2px 6px; border-radius:6px; font-weight:700}
  button{appearance:none;border:none;background:#1e293b;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  button.acc{background:var(--acc);color:#04121e}
  button.ghost{background:transparent;border:1px dashed var(--border)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .hint{font-size:13px;color:var(--muted)}
  .footer{padding:12px;text-align:center;color:var(--muted);font-size:12px}

  /* Circular timer */
  .timer-wrap{position:relative;width:80px;height:80px}
  .timer{transform:rotate(-90deg)}
  .timer circle{fill:none;stroke:#0b162d;stroke-width:8}
  .timer .fg{stroke:url(#g1);stroke-linecap:round;transition:stroke-dashoffset .2s linear}
  .timer-label{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:14px}

  /* Reveal */
  .reveal-wrap{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px}
  svg{width:100%;height:580px;background:#0b162d;border:1px solid var(--border);border-radius:12px}
  .legend{background:#0b162d;border:1px solid var(--border);border-radius:12px;padding:12px}
  .pill{display:inline-block;background:#0c1d36;border:1px solid var(--border);padding:6px 10px;border-radius:999px;margin:4px 6px 0 0}
  .title2{font-size:18px;font-weight:800;margin:0 0 6px 0}
  .winner{color:var(--good);font-weight:800}
  .share{display:flex;gap:10px;flex-wrap:wrap}
  .fadein{opacity:0;animation:fade 620ms ease forwards}
  @keyframes fade{to{opacity:1}}
  .line{stroke:#60a5fa; stroke-opacity:.85; stroke-linecap:round}
  .node{fill:#e5e7eb}
  .label{font-size:12px; fill:#cdd7ee; dominant-baseline:middle; text-anchor:middle}

  /* Toast */
  #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#0b162d;border:1px solid #27324a;color:#e5e7eb;padding:8px 12px;border-radius:999px;font-weight:800;z-index:9999;opacity:0;transition:opacity .15s}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Sokkosidokset ‚Äì P√§iv√§n challenge</h1>
    <div class="banner">
      <span class="badge" id="dayBadge">T√§n√§√§n: ‚Äî</span>
      <span class="badge" id="streakBadge">üî• Streak 0</span>
      <span class="sub">6 kierrosta, ei v√§lituloksia ‚Äì kaikki paljastuu lopussa.</span>
    </div>
  </div>
</header>

<main>
  <div class="card" id="screen"></div>
</main>

<div class="footer">¬© <span id="year"></span> Reaktioaika.fi ‚Ä¢ Demo</div>
<div id="toast"></div>

<script>
(() => {
  // ---------- Utils / seed ----------
  const YEAR = document.getElementById('year'); YEAR.textContent = new Date().getFullYear();
  const dayKey = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD
  document.getElementById('dayBadge').textContent = `T√§n√§√§n: ${dayKey()}`;
  const SECRET = "sokkosidokset-v1"; // vaihda kausittain

  function fnv1a(str){
    let h=0x811c9dc5;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); }
    return h>>>0;
  }
  function rng(seedStr){
    let s = fnv1a(seedStr) || 123456789;
    return function(){
      s ^= s<<13; s ^= s>>>17; s ^= s<<5; s >>>=0;
      return (s % 1e9)/1e9;
    }
  }
  const pick = (arr, r) => arr[Math.floor((r??Math.random())*arr.length)];
  const shuffle = (arr, rnd)=>{ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr };

  // ---------- State ----------
  const screen = document.getElementById('screen');
  let playerName = "";
  let players = []; // {id,name,isHuman}
  let rounds = [];  // generated questions
  let theme = "ystavat";
  let current = -1;
  let answers = {}; // per round: { playerId: {choices:[ids]} }
  let timerInt = null; let timeLeft = 0;
  let roundDone = false; // est√§ tuplasiirtym√§

  const BOT_NAMES = ["Nova","Orion","Vega","Kide","Saga","Myrsky","Aava","Pixel","Zen","Echo","Flux","Lyra","Kuu","Bolt","Halo"];

  // ---------- Question sets by theme ----------
  const Q = {
    ystavat: {
      pair: [
        "Ketk√§ perustaisivat parhaan startupin?",
        "Kenen kahden yhteisty√∂ olisi yll√§tt√§v√§n tehokasta?",
        "Kaksikko, joka voittaisi Amazing Race ‚Äëkilpailun?",
        "Ketk√§ tekisiv√§t viihdytt√§vimm√§n podcastin?"
      ],
      single: [
        "Kuka johtaisi parhaiten salaseuraa?",
        "Kuka pysyy rauhallisimpana paineen alla?",
        "Kenen pokerinaama on vahvin?",
        "Kuka vakuuttaisi tuomarit pitchiss√§?"
      ],
      group3: [
        "Ketk√§ olisivat t√§ydellinen tiimi maailmanpelastukseen?",
        "Kolmikko, joka voittaisi tietovisan?",
        "Ketk√§ eksyisiv√§t mutta selvi√§isiv√§t nauraen?",
        "Paras tiimi hackathoniin?"
      ]
    },
    tyo: {
      pair: [
        "Kaksikko, joka ratkaisisi eniten tikettej√§ p√§iv√§ss√§?",
        "Ketk√§ pit√§v√§t parhaan sprinttiretrospektiivin?",
        "Kaksi parasta sales‚Äëtiimiss√§?"
      ],
      single: [
        "Kuka hoitaisi kriisipalaverin tyylikk√§immin?",
        "Kuka tekee parhaat speksit?",
        "Kenell√§ pysyy roadmap hanskassa?"
      ],
      group3: [
        "Kolmikko, joka toimittaisi MVP:n viikonlopussa?",
        "Dream team asiakkaan kanssa neuvotteluun?",
        "Ketk√§ rakentaisivat parhaan yhteishengen?"
      ]
    },
    juhlat: {
      pair: [
        "Kaksikko, joka keksii parhaat juhlapelit?",
        "Ketk√§ vet√§v√§t parhaat tanssiliikkeet?",
        "Kaksi parasta DJ‚Äëvuoroon?"
      ],
      single: [
        "Kuka on paras is√§nt√§/em√§nt√§?",
        "Kuka saa kaikki nauramaan?",
        "Kuka keksii parhaat teemakutsut?"
      ],
      group3: [
        "Kolmikko, joka hoitaa ruuat, musiikin ja ohjelman?",
        "Ketk√§ rakentavat tunnelman hetkess√§?",
        "Ketk√§ siivoavat tehokkaimmin (oikeasti)?"
      ]
    },
    scifi: {
      pair: [
        "Kaksikko, joka pilotoi avaruusaluksen turvallisimmin?",
        "Ketk√§ pakenisivat asteroidivy√∂hykkeelt√§?",
        "Kaksi parasta kyberetsiv√§√§?"
      ],
      single: [
        "Kuka johtaisi kapinalliset voittoon?",
        "Kuka neuvottelisi alienien kanssa?",
        "Kuka on paras t√§htikartaston lukija?"
      ],
      group3: [
        "Kolmikko, joka perustaa siirtokunnan Marsiin?",
        "Ketk√§ ratkaisisivat aikaparadoksin?",
        "Ketk√§ salaisessa speis‚Äëheistiss√§ onnistuisi?"
      ]
    }
  };

  // ---------- Screens ----------
  renderIntro();

  function renderIntro(){
    screen.innerHTML = `
      <div class="grid" style="gap:12px; text-align:center">
        <div class="title">P√§iv√§n challenge (soolo)</div>
        <div class="sub">Valitse teema, sy√∂t√§ nimimerkki ja pelaa 6 kierrosta bottien kanssa. Mit√§√§n tuloksia ei n√§ytet√§ kesken pelin ‚Äì kaikki paljastuu lopussa.</div>
        <div class="grid" style="grid-template-columns:1fr; max-width:600px; margin:0 auto; gap:10px">
          <label class="sub" style="text-align:left">Teema</label>
          <select id="theme" style="padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b162d;color:var(--text);font-weight:700">
            <option value="ystavat">Yst√§v√§t</option>
            <option value="tyo">Ty√∂</option>
            <option value="juhlat">Juhlat</option>
            <option value="scifi">Scifi</option>
          </select>
          <input id="nick" placeholder="Nimimerkki" maxlength="16" style="padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b162d;color:var(--text);text-align:center;font-weight:800" />
          <button id="start" class="acc">Aloita p√§iv√§n haaste</button>
          <div class="hint">Vinkki: Enter lukitsee vastauksen, kun valinnat ovat t√§ynn√§.</div>
        </div>
      </div>
    `;
    document.getElementById('start').onclick = () => {
      theme = document.getElementById('theme').value;
      const v = (document.getElementById('nick').value || "").trim();
      playerName = v || "Sin√§";
      initGame();
      nextRound();
    };
  }

  function initGame(){
    const botRnd = rng(dayKey()+SECRET+"-bots-"+theme);
    const available = BOT_NAMES.slice();
    shuffle(available, botRnd);
    players = [{id:"p0",name:playerName,isHuman:true}];
    for(let i=1;i<=7;i++){ players.push({id:"p"+i, name:available[i-1], isHuman:false}); }

    // 6 deterministic rounds by theme
    const rr = rng(dayKey()+SECRET+"-rounds-"+theme);
    const pool = [];
    pool.push({type:"pair", pick:2, text:pick(Q[theme].pair, rr())});
    pool.push({type:"single", pick:1, text:pick(Q[theme].single, rr())});
    pool.push({type:"group3", pick:3, text:pick(Q[theme].group3, rr())});
    pool.push({type:"pair", pick:2, text:pick(Q[theme].pair, rr())});
    pool.push({type:"single", pick:1, text:pick(Q[theme].single, rr())});
    // salainen kierros
    pool.push({type: rr()>0.5?"pair":"single", pick: rr()>0.5?2:1, text: rr()>0.5?pick(Q[theme].pair, rr()):pick(Q[theme].single, rr()), secret:true});
    rounds = pool;
    answers = {};
    updateStreak(false);
  }

  function nextRound(){
    current++;
    if(current >= rounds.length){ revealAll(); return; }
    roundDone = false;
    renderRound(rounds[current], current+1, rounds.length);
    startTimer(55, finishRoundAuto);
  }

  function renderRound(r, idx, total){
    const you = players[0];
    const others = players.slice(1);
    const mustPick = r.type==="pair"?2 : r.type==="group3"?3 : 1;

    screen.innerHTML = `
      <div class="grid" style="gap:14px">
        <div class="row" style="justify-content:space-between">
          <div class="title">Kierros ${idx}/${total} ¬∑ ${prettyType(r)}</div>
          <div class="row" style="gap:12px">
            <div class="hint">Aikaraja</div>
            <div class="timer-wrap" aria-label="Aikaraja">
              <svg class="timer" viewBox="0 0 100 100" role="img" aria-hidden="true">
                <defs>
                  <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0%" stop-color="#22c55e"/><stop offset="100%" stop-color="#38bdf8"/>
                  </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="44"></circle>
                <circle cx="50" cy="50" r="44" class="fg" id="ring" stroke-dasharray="276" stroke-dashoffset="0"></circle>
              </svg>
              <div class="timer-label" id="timerLbl">55</div>
            </div>
          </div>
        </div>
        <div class="grid" style="gap:6px">
          <div class="sub">${r.secret?'<span class="badge">Salainen kierros</span> ':''}${r.text}</div>
          <div class="hint">Valitse <strong>${mustPick}</strong> ${r.type==="pair"?"henkil√∂√§ (pari)":"henkil√∂(√§)"} ‚Äì et voi valita itse√§si.</div>
        </div>
        <div class="grid players" id="pickArea"></div>
        <div class="row" style="justify-content:space-between; margin-top:6px">
          <div class="hint" id="selHint">Valintoja: 0 / ${mustPick}</div>
          <div class="row">
            <button class="ghost" id="clearBtn">Tyhjenn√§</button>
            <button class="acc" id="lockBtn" disabled>Lukitse vastaus (Enter)</button>
          </div>
        </div>
      </div>
    `;

    const area = document.getElementById('pickArea');
    const sel = new Set();
    function renderChips(){
      area.innerHTML = others.map(p => {
        const pressed = sel.has(p.id) ? 'aria-pressed="true"' : '';
        return `<div class="chip" tabindex="0" data-id="${p.id}" ${pressed}><span>${p.name}</span><span class="muted">${p.id}</span></div>`;
      }).join('');
      document.querySelectorAll('.chip').forEach(el=>{
        el.onclick = () => toggle(el.getAttribute('data-id'));
        el.onkeydown = (e) => { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(el.getAttribute('data-id')); } };
      });
    }
    function toggle(id){
      if (sel.has(id)) sel.delete(id);
      else if (sel.size < mustPick) sel.add(id);
      document.getElementById('selHint').textContent = `Valintoja: ${sel.size} / ${mustPick}`;
      document.getElementById('lockBtn').disabled = sel.size !== mustPick;
      renderChips();
    }
    renderChips();

    document.getElementById('clearBtn').onclick = () => {
      sel.clear(); renderChips(); document.getElementById('selHint').textContent = `Valintoja: 0 / ${mustPick}`;
      document.getElementById('lockBtn').disabled = true;
    };
    const lock = () => {
      if (sel.size !== mustPick) return;
      stopTimer();
      if(!answers[current]) answers[current] = {};
      answers[current][you.id] = { choices: Array.from(sel) };
      showToast("Vastaus lukittu");
      botAnswerRound(r, current);   // botit vastaavat
      maybeAdvance();               // siirry heti jos kaikki valmiit
    };
    document.getElementById('lockBtn').onclick = lock;
    const keyLockOnce = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); lock(); document.removeEventListener('keydown', keyLockOnce); } };
    document.addEventListener('keydown', keyLockOnce, { once:true });
  }

  function prettyType(r){ return r.type==='pair'?'Paritus':r.type==='single'?'Yksil√∂':'Pienryhm√§ (3)'; }

  // ---------- Timer (circular) ----------
  function startTimer(seconds, onDone){
    stopTimer();
    const ring = document.getElementById('ring');
    const lbl = document.getElementById('timerLbl');
    if(!ring || !lbl) return;
    const C = 2*Math.PI*44; // ~276
    timeLeft = seconds;
    const total = seconds;
    ring.style.strokeDasharray = String(C);
    lbl.textContent = String(seconds);
    timerInt = setInterval(()=>{
      timeLeft--;
      const ratio = Math.max(0, (total-timeLeft)/total);
      ring.style.strokeDashoffset = String(ratio*C);
      lbl.textContent = String(Math.max(0,timeLeft));
      if(timeLeft<=0){ stopTimer(); onDone?.(); }
    }, 1000);
  }
  function stopTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } }

  function finishRoundAuto(){ // aika loppui ‚Üí kirjaa tyhj√§, botit vastaavat, etene jos valmista
    if(!answers[current]) answers[current]={};
    if(!answers[current]["p0"]) answers[current]["p0"]={choices:[]};
    botAnswerRound(rounds[current], current);
    maybeAdvance();
  }

  // ---------- Eteneminen automaattisesti ----------
  function maybeAdvance(){
    const a = answers[current] || {};
    if (!roundDone && Object.keys(a).length === players.length) {
      roundDone = true;
      setTimeout(() => nextRound(), 300); // pieni viive tuntuman vuoksi
    }
  }

  // ---------- Bot logic ----------
  function botAnswerRound(r, idx){
    const rr = rng(dayKey()+SECRET+"-r"+idx+"-"+theme);
    const aff = {};
    players.forEach(a=>{
      aff[a.id]={};
      players.forEach(b=>{
        aff[a.id][b.id] = a.id===b.id?0 : 0.2 + rr()*0.8; // 0.2‚Äì1.0
      });
    });

    players.filter(p=>!p.isHuman).forEach(bot=>{
      const pool = players.filter(x=>x.id!==bot.id).map(x=>x.id);
      if(r.type==="pair"){
        const cand = shuffle(pool.slice(), rr);
        let best=[pool[0],pool[1]], bestScore=-1;
        for(let i=0;i<cand.length;i++){
          for(let j=i+1;j<cand.length;j++){
            const a=cand[i], b=cand[j];
            const score = aff[bot.id][a]+aff[bot.id][b] + rr()*0.5;
            if(score>bestScore){ bestScore=score; best=[a,b]; }
          }
        }
        commit(bot.id, best);
      } else if(r.type==="single"){
        const scored = pool.map(id=>({id,score:aff[bot.id][id]+rr()*0.7})).sort((a,b)=>b.score-a.score);
        commit(bot.id, [scored[0].id]);
      } else if(r.type==="group3"){
        const scored = pool.map(id=>({id,score:aff[bot.id][id]+rr()*0.5})).sort((a,b)=>b.score-a-score).slice(0,3);
        commit(bot.id, scored.map(x=>x.id));
      }
    });
    function commit(pid, ids){ if(!answers[idx]) answers[idx]={}; answers[idx][pid]={choices:ids}; }
    // kun botit valmiit, tarkista voiko edet√§
    maybeAdvance();
  }

  // ---------- Reveal & PNG export ----------
  function revealAll(){
    const id2idx = new Map(players.map((p,i)=>[p.id,i]));
    const N = players.length;
    const adj = Array.from({length:N},()=>Array(N).fill(0));
    const mention = Array(N).fill(0);
    const secretIndex = rounds.findIndex(r=>r.secret);

    rounds.forEach((r,ri)=>{
      const A = answers[ri] || {};
      Object.values(A).forEach(obj=>{
        const sel = obj.choices||[];
        if(r.type==="pair" && sel.length===2){
          const i=id2idx.get(sel[0]), j=id2idx.get(sel[1]);
          if(i!=null && j!=null){ adj[i][j]+=1; adj[j][i]+=1; mention[i]+=1; mention[j]+=1; }
        } else if(r.type==="single" && sel.length===1){
          const i=id2idx.get(sel[0]); if(i!=null){ mention[i]+=1; }
        } else if(r.type==="group3" && sel.length===3){
          const [a,b,c]=sel.map(x=>id2idx.get(x));
          if(a!=null&&b!=null){ adj[a][b]+=0.5; adj[b][a]+=0.5; }
          if(a!=null&&c!=null){ adj[a][c]+=0.5; adj[c][a]+=0.5; }
          if(b!=null&&c!=null){ adj[b][c]+=0.5; adj[c][b]+=0.5; }
          [a,b,c].forEach(k=>{ if(k!=null) mention[k]+=1; });
        }
      });
    });

    const degree = adj.map(row=>row.reduce((a,b)=>a+b,0));
    const mostMentionIdx = argMax(mention);
    const centerIdx = argMax(degree);
    let secretMentions = Array(N).fill(0);
    if(secretIndex>=0){
      const A = answers[secretIndex]||{};
      Object.values(A).forEach(o=>{
        (o.choices||[]).forEach(id=>{
          const k=id2idx.get(id); if(k!=null) secretMentions[k]+=1;
        });
      });
    }
    const secretIdx = secretIndex>=0 ? argMax(secretMentions) : null;

    const wildPairs=[];
    for(let i=0;i<N;i++){
      for(let j=i+1;j<N;j++){
        const w=adj[i][j];
        if(w>0 && w<=1) wildPairs.push({i,j,w});
      }
    }

    const youIdx=0;
    const winToday = [mostMentionIdx,centerIdx].includes(youIdx);
    const streak = updateStreak(winToday);

    renderReveal({adj, mention, degree, mostMentionIdx, centerIdx, secretIdx, wildPairs, streak});
  }

  function renderReveal({adj, mention, degree, mostMentionIdx, centerIdx, secretIdx, wildPairs, streak}){
    const W=800,H=580,cx=W/2,cy=H/2,R=Math.min(W,H)/2-70;
    const pos = players.map((p,i)=>{ const ang=(i/players.length)*(Math.PI*2)-Math.PI/2; return {x:cx+R*Math.cos(ang), y:cy+R*Math.sin(ang)}; });

    const maxW = maxMatrix(adj);
    const lines=[];
    for(let i=0;i<players.length;i++){
      for(let j=i+1;j<players.length;j++){
        const w=adj[i][j];
        if(w<=0) continue;
        const sw=1+(w/maxW)*8;
        lines.push({i,j,sw,delay:80*(lines.length+1)});
      }
    }

    screen.innerHTML = `
      <div class="reveal-wrap">
        <div>
          <div class="title">Paljastus</div>
          <div class="sub">Viivat syttyv√§t kierroksien mukaan. Paksuus = vahvuus. Klikkaa solmua n√§hd√§ksesi summat.</div>
          <svg viewBox="0 0 ${W} ${H}" id="net">
            <g id="edges"></g>
            <g id="nodes"></g>
          </svg>
        </div>
        <div class="legend">
          <p class="title2">Tittelit</p>
          <div id="awards" class="grid" style="gap:8px"></div>
          <hr style="border:0;border-top:1px solid var(--border);margin:12px 0" />
          <p class="title2">Yhteenveto</p>
          <div class="grid" id="summary" style="gap:6px"></div>
          <div class="share" style="margin-top:10px">
            <button class="acc" id="againBtn">Pelaa uudestaan</button>
            <button id="savePngBtn">üíæ Tallenna verkko (PNG)</button>
            <button id="shareBtn">üì§ Jaa tulos</button>
          </div>
          <div class="hint" style="margin-top:6px">P√§iv√§n challenge: <strong>${dayKey()}</strong>, Teema: <strong>${theme}</strong>. Streak: <strong>${streak}</strong>.</div>
        </div>
      </div>
    `;

    const gEdges = document.getElementById('edges');
    lines.forEach(L=>{
      const a=pos[L.i], b=pos[L.j];
      const el = document.createElementNS("http://www.w3.org/2000/svg","line");
      el.setAttribute("x1",a.x); el.setAttribute("y1",a.y);
      el.setAttribute("x2",b.x); el.setAttribute("y2",b.y);
      el.setAttribute("stroke-width", String(L.sw));
      el.setAttribute("class","line fadein");
      el.style.animationDelay = (200+L.delay)+"ms";
      gEdges.appendChild(el);
    });

    const gNodes = document.getElementById('nodes');
    players.forEach((p,i)=>{
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("transform",`translate(${pos[i].x},${pos[i].y})`);
      const r = 16 + Math.min(18, mention[i]);
      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("r", String(r)); c.setAttribute("class","node");
      const label = document.createElementNS("http://www.w3.org/2000/svg","text");
      label.setAttribute("class","label"); label.setAttribute("y", String(r+14)); label.textContent=p.name;
      g.appendChild(c); g.appendChild(label);
      g.addEventListener('click', ()=>{
        const s=document.getElementById('summary');
        s.innerHTML = `
          <div class="pill"><strong>${p.name}</strong></div>
          <div class="pill">Maininnat: <strong>${mention[i]}</strong></div>
          <div class="pill">Asteen summa (linkit): <strong>${degree[i].toFixed(1)}</strong></div>
        `;
      });
      gNodes.appendChild(g);
    });

    const awards = document.getElementById('awards');
    const ym = players[mostMentionIdx]?.name;
    const ck = players[centerIdx]?.name;
    const ss = (secretIdx!=null && secretIdx>=0) ? players[secretIdx]?.name : null;
    const wild = wildPairs.slice(0,3).map(w=>`${players[w.i].name} ‚Äî ${players[w.j].name}`);
    awards.innerHTML = `
      <div class="pill">üèÜ <strong>Yhteyksien mestari:</strong> <span class="winner">${ym}</span></div>
      <div class="pill">üï∏Ô∏è <strong>Keski√∂:</strong> <span class="winner">${ck}</span></div>
      ${ss?`<div class="pill">ü´• <strong>Salainen suosikki:</strong> <span class="winner">${ss}</span></div>`:""}
      ${wild.length?`<div class="pill">üÉè <strong>Villikortit:</strong> ${wild.join(", ")}</div>`:""}
    `;

    document.getElementById('againBtn').onclick = () => location.reload();

    document.getElementById('savePngBtn').onclick = () => {
      const svg = document.getElementById('net');
      const serializer = new XMLSerializer();
      const src = serializer.serializeToString(svg);
      const svgBlob = new Blob([src], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);
      const img = new Image();
      img.onload = function(){
        const canvas = document.createElement('canvas');
        canvas.width = svg.viewBox.baseVal.width;
        canvas.height = svg.viewBox.baseVal.height;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "#0b162d";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0);
        URL.revokeObjectURL(url);
        canvas.toBlob((blob)=>{
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `sokkosidokset-${dayKey()}-${theme}.png`;
          a.click();
        });
      };
      img.src = url;
    };

    document.getElementById('shareBtn').onclick = async () => {
      const text = `Sokkosidokset ‚Äì P√§iv√§n challenge ${dayKey()} (${theme})\nMestari: ${players[mostMentionIdx]?.name}, Keski√∂: ${players[centerIdx]?.name}\nKokeile: ${location.href}`;
      try{
        if(navigator.share){ await navigator.share({title:"Sokkosidokset", text, url: location.href}); }
        else { await navigator.clipboard.writeText(text); alert("Kopioitu leikep√∂yd√§lle!"); }
      }catch{}
    };
  }

  // ---------- helpers ----------
  const argMax = (arr)=>{ let m=-Infinity,idx=0; for(let i=0;i<arr.length;i++){ if(arr[i]>m){m=arr[i]; idx=i;} } return idx; }
  const maxMatrix = (m)=>{ let mx=0; for(let i=0;i<m.length;i++){ for(let j=0;j<m[i].length;j++){ if(m[i][j]>mx) mx=m[i][j]; } } return Math.max(mx,1); }

  function updateStreak(win){
    const last = localStorage.getItem('ss_last');
    const today = dayKey();
    let streak = Number(localStorage.getItem('ss_streak')||0);
    if(win){
      if(last && daysDiff(last,today)===1) streak++;
      else streak = 1;
      localStorage.setItem('ss_last', today);
      localStorage.setItem('ss_streak', String(streak));
    }
    const sb = document.getElementById('streakBadge');
    if(sb) sb.textContent = `üî• Streak ${streak}`;
    return streak;
  }
  function daysDiff(a,b){
    const d1=new Date(a+"T00:00:00Z").getTime(), d2=new Date(b+"T00:00:00Z").getTime();
    return Math.round((d2-d1)/86400000);
  }

  function showToast(txt){
    const t = document.getElementById('toast');
    t.textContent = txt; t.style.opacity='1';
    setTimeout(()=> t.style.opacity='0', 550);
  }
})();
</script>
</body>
</html>
